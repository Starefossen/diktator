[tools]
go = "1.25"
node = "24"
opentofu = "latest"
air = "latest"
pnpm = "10"

# ============================================================================
# Environment Configuration
# ============================================================================
[env]
# Static configuration - same across all environments
DIKTATOR_APP_NAME = "diktator"
DIKTATOR_API_SERVICE_NAME = "diktator-api"
DIKTATOR_DEFAULT_REGION = "europe-north1"
DIKTATOR_BUCKET_LOCATION = "EU"

# Development environment defaults
GOOGLE_CLOUD_PROJECT = "diktator-dev"
GOOGLE_CLOUD_QUOTA_PROJECT = "diktator-app"
STORAGE_BUCKET = "diktator-dev.appspot.com"
GIN_MODE = "debug"

# PostgreSQL configuration
DATABASE_URL = "postgresql://postgres:postgres@localhost:5432/diktator?sslmode=disable"
DATABASE_TEST_URL = "postgresql://postgres:postgres@localhost:5432/diktator_test?sslmode=disable"

# Authentication - mock mode for development
AUTH_MODE = "mock"

# Frontend configuration
NEXT_PUBLIC_API_URL = "http://localhost:8080"
NEXT_PUBLIC_AUTH_MODE = "mock"

# ============================================================================
# Development Tasks
# ============================================================================

[tasks.install]
description = "Install all dependencies"
run = [
    "cd frontend && pnpm install",
    "cd backend && go mod tidy",
    "go install github.com/swaggo/swag/cmd/swag@latest",
]

[tasks.dev]
description = "Start full development environment (PostgreSQL + frontend + backend)"
run = """
echo "ğŸš€ Starting full development environment..."

# Ensure config exists
if [ ! -f backend/.env.development ]; then
    echo "ğŸ“ Generating development config..."
    mise run config-dev
fi

# Ensure dependencies are installed
if [ ! -d frontend/node_modules ] || [ ! -f backend/go.sum ]; then
    echo "ğŸ“¦ Installing dependencies..."
    mise run install
fi

# Start PostgreSQL
echo "ğŸ˜ Starting PostgreSQL..."
docker compose -f docker-compose.dev.yml up -d
sleep 3

# Run migrations
echo "ğŸ—„ï¸  Running database migrations..."
mise run db:migrate

# Start backend with air (hot reload) in background
echo "ğŸ”§ Starting backend with hot reload..."
cd backend && set -a && source .env.development && set +a && air &
BACKEND_PID=$!
sleep 3

# Check if backend started successfully
if ! kill -0 $BACKEND_PID 2>/dev/null; then
    echo "âŒ Backend failed to start"
    exit 1
fi

echo "âœ… Backend started (PID: $BACKEND_PID)"

# Start frontend
echo "âš›ï¸  Starting frontend..."
cd frontend && cp .env.development .env.local && pnpm run dev

# Cleanup on exit
cleanup() {
    echo ""
    echo "ğŸ›‘ Stopping services..."
    kill $BACKEND_PID 2>/dev/null || true
    docker compose -f docker-compose.dev.yml down
}
trap cleanup EXIT INT TERM
"""

[tasks."frontend:dev"]
description = "Start frontend development server"
run = """
if [ ! -f frontend/.env.development ]; then
    mise run config-dev
fi
cd frontend
cp .env.development .env.local
pnpm run dev
"""

[tasks."backend:dev"]
description = "Start backend with hot reload (air)"
run = """
if [ ! -f backend/.env.development ]; then
    mise run config-dev
fi
cd backend
set -a && source .env.development && set +a && air
"""

# ============================================================================
# Backend Service Management
# ============================================================================

[tasks."backend:start"]
description = "Start backend in background"
run = """
mkdir -p .tmp

if [ -f .tmp/backend.pid ] && kill -0 $(cat .tmp/backend.pid) 2>/dev/null; then
    echo "âš ï¸  Backend already running (PID: $(cat .tmp/backend.pid))"
    exit 0
fi

if [ ! -f backend/.env.development ]; then
    mise run config-dev
fi

# Ensure PostgreSQL is running
if ! docker compose -f docker-compose.dev.yml ps postgres 2>/dev/null | grep -q "running"; then
    echo "ğŸ˜ Starting PostgreSQL..."
    docker compose -f docker-compose.dev.yml up -d postgres
    sleep 3
fi

echo "ğŸš€ Starting backend..."
cd backend
set -a && source .env.development && set +a
nohup go run cmd/server/main.go > ../.tmp/backend.log 2>&1 &
echo $! > ../.tmp/backend.pid
cd ..

sleep 3
if kill -0 $(cat .tmp/backend.pid) 2>/dev/null; then
    echo "âœ… Backend started (PID: $(cat .tmp/backend.pid))"
    echo "   Logs: .tmp/backend.log"
    curl -s http://localhost:8080/health | head -c 100
    echo ""
else
    echo "âŒ Backend failed to start"
    tail -20 .tmp/backend.log
    exit 1
fi
"""

[tasks."backend:stop"]
description = "Stop backend"
run = """
if [ -f .tmp/backend.pid ]; then
    PID=$(cat .tmp/backend.pid)
    if kill -0 $PID 2>/dev/null; then
        echo "Stopping backend (PID: $PID)..."
        kill $PID
        sleep 1
        kill -0 $PID 2>/dev/null && kill -9 $PID
        echo "âœ… Backend stopped"
    fi
    rm -f .tmp/backend.pid
else
    lsof -ti:8080 | xargs kill -9 2>/dev/null || true
fi
"""

[tasks."backend:logs"]
description = "View backend logs"
run = """
if [ -f .tmp/backend.log ]; then
    tail -f .tmp/backend.log
else
    echo "No log file found. Start backend with 'mise run backend:start'"
fi
"""

[tasks."backend:status"]
description = "Check backend status"
run = """
if [ -f .tmp/backend.pid ] && kill -0 $(cat .tmp/backend.pid) 2>/dev/null; then
    echo "âœ… Backend running (PID: $(cat .tmp/backend.pid))"
    curl -s http://localhost:8080/health 2>/dev/null || echo "âŒ Not responding"
else
    echo "âŒ Backend not running"
fi
"""

[tasks."backend:restart"]
description = "Restart backend"
run = "mise run backend:stop && sleep 1 && mise run backend:start"

# ============================================================================
# Database Tasks
# ============================================================================

[tasks."db:start"]
description = "Start PostgreSQL"
run = """
docker compose -f docker-compose.dev.yml up -d
echo "PostgreSQL started at localhost:5432"
"""

[tasks."db:stop"]
description = "Stop PostgreSQL"
run = "docker compose -f docker-compose.dev.yml down"

[tasks."db:reset"]
description = "Reset database (destroy and recreate)"
run = """
echo "WARNING: This will delete all data!"
read -p "Are you sure? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    docker compose -f docker-compose.dev.yml down -v
    docker compose -f docker-compose.dev.yml up -d
    sleep 3
    mise run db:migrate
fi
"""

[tasks."db:migrate"]
description = "Run database migrations"
run = """
echo "Running database migrations..."
for migration in migrations/*_*.up.sql; do
    if [ -f "$migration" ]; then
        echo "Applying $(basename "$migration") to diktator..."
        docker compose -f docker-compose.dev.yml exec -T postgres psql -U postgres -d diktator < "$migration"
    fi
done
echo "âœ… All migrations completed."
"""

[tasks."db:migrate-test"]
description = "Run database migrations on test database"
run = """
echo "Running test database migrations..."
for migration in migrations/*_*.up.sql; do
    if [ -f "$migration" ]; then
        echo "Applying $(basename "$migration") to diktator_test..."
        docker compose -f docker-compose.dev.yml exec -T postgres psql -U postgres -d diktator_test < "$migration"
    fi
done
echo "âœ… Test database migrations completed."
"""

[tasks."db:reset-test"]
description = "Reset test database (destroy and recreate)"
run = """
echo "Resetting test database..."
docker compose -f docker-compose.dev.yml exec -T postgres psql -U postgres -c "DROP DATABASE IF EXISTS diktator_test;"
docker compose -f docker-compose.dev.yml exec -T postgres psql -U postgres -c "CREATE DATABASE diktator_test;"
sleep 1
mise run db:migrate-test
echo "âœ… Test database reset complete."
"""

[tasks."db:shell"]
description = "Open PostgreSQL shell"
run = "docker compose -f docker-compose.dev.yml exec postgres psql -U postgres -d diktator"

[tasks."db:seed"]
description = "Seed database with test data"
run = """
echo "ğŸŒ± Seeding database with test data..."
(cd backend && go run cmd/seed/main.go)
"""

[tasks."db:reset-seed"]
description = "Reset database and seed with fresh test data"
run = """
echo "ğŸ”„ Resetting database..."
mise run db:reset

echo "â³ Waiting for database..."
sleep 5

echo "ğŸ—„ï¸  Running migrations..."
mise run db:migrate

echo "ğŸŒ± Seeding test data..."
(cd backend && go run cmd/seed/main.go)

echo "âœ… Database reset and seeded!"
"""

# ============================================================================
# Code Quality
# ============================================================================

[tasks.lint]
description = "Run linters"
run = ["cd frontend && pnpm run lint", "cd backend && go vet ./..."]

[tasks.format]
description = "Format code"
run = [
    "cd frontend && pnpm run format",
    "cd backend && go fmt ./...",
    "mise run tofu:fmt",
]

[tasks.typecheck]
description = "Type check all code"
run = [
    "cd frontend && pnpm run typecheck",
    "cd backend && go build -o /dev/null ./...",
]

[tasks."frontend:knip"]
description = "Find unused code in frontend"
run = "cd frontend && pnpm run knip"

[tasks."frontend:knip-fix"]
description = "Auto-fix unused code in frontend"
run = "cd frontend && pnpm run knip:fix"

[tasks."frontend:check"]
description = "Run all frontend checks (typecheck, lint:fix, format, knip:fix, test) with auto-fixing"
run = "cd frontend && pnpm run check"

[tasks."frontend:build"]
description = "Build frontend for production"
run = """
cd frontend
cp .env.production .env.local 2>/dev/null || true
NODE_ENV=production pnpm run build
"""

[tasks."backend:check"]
description = "Run all backend checks (fmt, vet, test) with auto-fixing"
run = """
echo "ğŸ”§ Running backend checks..."
echo ""
echo "ğŸ“ Formatting code..."
(cd backend && go fmt ./...)

echo ""
echo "ğŸ” Running go vet..."
(cd backend && go vet ./...)

echo ""
echo "ğŸ§ª Running tests..."

if ! docker compose -f docker-compose.dev.yml ps postgres 2>/dev/null | grep -q "running"; then
    echo "ğŸ˜ Starting PostgreSQL..."
    docker compose -f docker-compose.dev.yml up -d postgres
    sleep 3
fi

# Run migrations on test database
echo "ğŸ—„ï¸  Running test database migrations..."
for migration in migrations/*_*.up.sql; do
    if [ -f "$migration" ]; then
        docker compose -f docker-compose.dev.yml exec -T postgres psql -U postgres -d diktator_test < "$migration" 2>/dev/null || true
    fi
done

(cd backend && DATABASE_URL="${DATABASE_TEST_URL}" go test ./...)

echo ""
echo "âœ… All backend checks passed!"
"""

[tasks.test]
description = "Run all tests (backend + frontend unit tests)"
run = """
echo "ğŸ§ª Running all tests..."

# Ensure PostgreSQL is running
if ! docker compose -f docker-compose.dev.yml ps postgres 2>/dev/null | grep -q "running"; then
    echo "ğŸ˜ Starting PostgreSQL..."
    docker compose -f docker-compose.dev.yml up -d postgres
    sleep 3
fi

echo ""
echo "ğŸ“‹ Running linters..."
mise run lint

echo ""
echo "ğŸ” Type checking..."
mise run typecheck

echo ""
echo "ğŸ”§ Backend tests..."
echo "ğŸ—„ï¸  Preparing test database..."
for migration in migrations/*_*.up.sql; do
    if [ -f "$migration" ]; then
        docker compose -f docker-compose.dev.yml exec -T postgres psql -U postgres -d diktator_test < "$migration" 2>/dev/null || true
    fi
done
(cd backend && DATABASE_URL="${DATABASE_TEST_URL}" go test ./...)

echo ""
echo "âš›ï¸  Frontend unit tests..."
(cd frontend && pnpm test)

echo ""
echo "âœ… All tests passed!"
"""

[tasks.test-unit]
description = "Run unit tests only (skip integration tests)"
run = """
echo "ğŸ§ª Running unit tests..."

echo ""
echo "ğŸ”§ Backend unit tests..."
(cd backend && go test -short ./...)

echo ""
echo "âš›ï¸  Frontend unit tests..."
(cd frontend && pnpm test)

echo "âœ… Unit tests passed!"
"""

[tasks."backend:test"]
description = "Run backend tests"
run = """
echo "ğŸ”§ Running backend tests..."

# Ensure PostgreSQL is running for integration tests
if ! docker compose -f docker-compose.dev.yml ps postgres 2>/dev/null | grep -q "running"; then
    echo "ğŸ˜ Starting PostgreSQL..."
    docker compose -f docker-compose.dev.yml up -d postgres
    sleep 3
fi

# Run migrations on test database
echo "ğŸ—„ï¸  Running test database migrations..."
for migration in migrations/*_*.up.sql; do
    if [ -f "$migration" ]; then
        docker compose -f docker-compose.dev.yml exec -T postgres psql -U postgres -d diktator_test < "$migration" 2>/dev/null || true
    fi
done

(cd backend && DATABASE_URL="${DATABASE_TEST_URL}" go test -v ./...)
"""

[tasks."backend:test-short"]
description = "Run backend tests without integration tests"
run = "(cd backend && go test -short -v ./...)"

[tasks."backend:test-coverage"]
description = "Run backend tests with coverage"
run = """
echo "ğŸ”§ Running backend tests with coverage..."

if ! docker compose -f docker-compose.dev.yml ps postgres 2>/dev/null | grep -q "running"; then
    echo "ğŸ˜ Starting PostgreSQL..."
    docker compose -f docker-compose.dev.yml up -d postgres
    sleep 3
fi

# Run migrations on test database
for migration in migrations/*_*.up.sql; do
    if [ -f "$migration" ]; then
        docker compose -f docker-compose.dev.yml exec -T postgres psql -U postgres -d diktator_test < "$migration" 2>/dev/null || true
    fi
done

(cd backend && \
    DATABASE_URL="${DATABASE_TEST_URL}" go test -coverprofile=coverage.out ./... && \
    go tool cover -html=coverage.out -o coverage.html)
echo "âœ… Coverage report: backend/coverage.html"
"""

[tasks."frontend:test"]
description = "Run frontend unit tests"
run = "(cd frontend && pnpm test)"

[tasks."frontend:test-watch"]
description = "Run frontend tests in watch mode"
run = "(cd frontend && pnpm test:watch)"

[tasks."frontend:test-coverage"]
description = "Run frontend tests with coverage"
run = "(cd frontend && pnpm test:coverage)"

[tasks."frontend:test-e2e"]
description = "Run frontend E2E tests with Playwright"
run = """
echo "ğŸ­ Running E2E tests..."

# Check if backend is running
if ! curl -s http://localhost:8080/health > /dev/null 2>&1; then
    echo "âš ï¸  Backend not running. Starting backend..."
    mise run backend:start
    sleep 5
fi

(cd frontend && pnpm test:e2e)
"""

[tasks."frontend:test-e2e-ui"]
description = "Run E2E tests with Playwright UI"
run = """
# Check if backend is running
if ! curl -s http://localhost:8080/health > /dev/null 2>&1; then
    echo "âš ï¸  Backend not running. Starting backend..."
    mise run backend:start
    sleep 5
fi

(cd frontend && pnpm test:e2e:ui)
"""

[tasks.test-all]
description = "Run all tests including E2E"
run = """
echo "ğŸ§ª Running complete test suite..."

mise run test
echo ""
echo "ğŸ­ Running E2E tests..."
mise run frontend:test-e2e

echo ""
echo "âœ… All tests (unit + E2E) passed!"
"""

[tasks.check]
description = "Run all checks (backend + frontend: fmt, lint, typecheck, knip, tests)"
run = """
echo "ğŸ” Running all checks..."
echo ""
echo "=== Backend Checks ==="
mise run backend:check

echo ""
echo "=== Frontend Checks ==="
mise run frontend:check

echo ""
echo "âœ… All checks passed!"
"""

[tasks.fmt]
description = "Format code (alias for format)"
run = "mise run format"

# ============================================================================
# API Documentation
# ============================================================================

[tasks."backend:swagger-gen"]
description = "Generate OpenAPI spec"
run = """
cd backend
command -v swag &>/dev/null || go install github.com/swaggo/swag/cmd/swag@latest
swag init -g cmd/server/main.go --output docs --parseInternal
echo "âœ… OpenAPI spec generated"
"""

[tasks."frontend:client-gen"]
description = "Generate TypeScript client"
run = """
cd frontend
npx @openapitools/openapi-generator-cli generate \
    -i ../backend/docs/swagger.json \
    -g typescript-axios \
    -o src/generated \
    --additional-properties=supportsES6=true,withInterfaces=true
echo "âœ… TypeScript client generated"
"""

# ============================================================================
# Build Tasks
# ============================================================================

[tasks.build]
description = "Build for production"
run = [
    "mise run backend:swagger-gen",
    "mise run config-prod",
    "cd frontend && cp .env.production .env.local && pnpm run build",
    "cd backend && go build -o bin/server cmd/server/main.go",
]

[tasks."backend:build-binary"]
description = "Build backend binary for target architecture"
run = """
ARCH=${TARGETARCH:-amd64}
echo "ğŸ”¨ Building backend binary for linux-${ARCH}..."
mkdir -p backend/bin
cd backend
CGO_ENABLED=0 GOOS=linux GOARCH=${ARCH} go build -ldflags="-w -s" -o bin/server-linux-${ARCH} ./cmd/server/main.go
echo "âœ… Binary built: backend/bin/server-linux-${ARCH}"
"""

[tasks."backend:docker-build"]
description = "Build backend Docker image (builds binary first)"
run = """
ARCH=${TARGETARCH:-amd64}
echo "ğŸ“¦ Building backend Docker image for ${ARCH}..."

# Build binary outside Docker for performance
mise run backend:build-binary

# Build minimal Docker image with pre-built binary
cd backend
docker build --build-arg TARGETARCH=${ARCH} -t diktator-api:latest -t diktator-api:${ARCH} .
echo "âœ… Built: diktator-api:latest (linux-${ARCH})"
"""

[tasks."frontend:docker-build"]
description = "Build frontend Docker image with nginx"
run = """
echo "ğŸ“¦ Building frontend Docker image..."

# Build frontend first
cd frontend
cp .env.production .env.local 2>/dev/null || true
NODE_ENV=production pnpm run build

# Build minimal Docker image with nginx
docker build -t diktator-frontend:latest .
echo "âœ… Built: diktator-frontend:latest"
"""

[tasks.clean]
description = "Clean build artifacts"
run = [
    "mise run backend:stop 2>/dev/null || true",
    "rm -rf frontend/.next frontend/out frontend/src/generated frontend/dist",
    "rm -rf backend/bin",
    "rm -f frontend/.env.local backend/.env.* frontend/.env.*",
    "rm -f .mise.env",
    "rm -rf .tmp",
]

# ============================================================================
# Setup & Configuration
# ============================================================================

[tasks.setup]
description = "Initial project setup"
run = """
echo "ğŸš€ Setting up Diktator..."

echo ""
echo "ğŸ“¦ Installing tools..."
mise install

echo ""
echo "ğŸ“ Generating development config..."
mise run config-dev

echo ""
echo "ğŸ“¦ Installing dependencies..."
mise run install

echo ""
echo "ğŸ˜ Starting PostgreSQL..."
docker compose -f docker-compose.dev.yml pull
docker compose -f docker-compose.dev.yml up -d
sleep 3

echo ""
echo "ğŸ—„ï¸  Running database migrations..."
mise run db:migrate

echo ""
echo "âœ… Setup complete!"
echo ""
echo "Next steps:"
echo "  Start full dev:     mise run dev"
echo "  Start backend only: mise run backend:start"
echo "  Start frontend:     mise run frontend:dev"
echo "  Run tests:          mise run test"
"""

[tasks.config-dev]
description = "Generate development configuration"
run = """
cat > backend/.env.development << 'EOF'
# Backend Development Configuration
GOOGLE_CLOUD_PROJECT=diktator-dev
GOOGLE_CLOUD_QUOTA_PROJECT=diktator-app
STORAGE_BUCKET=diktator-dev.appspot.com
GIN_MODE=debug
PORT=8080
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/diktator?sslmode=disable
DATABASE_TEST_URL=postgresql://postgres:postgres@localhost:5432/diktator_test?sslmode=disable
AUTH_MODE=mock
EOF

cat > frontend/.env.development << 'EOF'
# Frontend Development Configuration
NEXT_PUBLIC_API_URL=http://localhost:8080
NEXT_PUBLIC_AUTH_MODE=mock
NEXT_TELEMETRY_DISABLED=1
NODE_ENV=development
EOF

echo "âœ… Development config created"
"""

[tasks.config-prod]
description = "Generate production configuration"
run = """
if [ ! -f .mise.env ]; then
    echo "ERROR: .mise.env not found. Run 'mise run config-load' first."
    exit 1
fi
source .mise.env

cat > backend/.env.production << EOF
GOOGLE_CLOUD_PROJECT=${DIKTATOR_PROJECT_ID}
GOOGLE_CLOUD_QUOTA_PROJECT=${GOOGLE_CLOUD_QUOTA_PROJECT:-${DIKTATOR_PROJECT_ID}}
STORAGE_BUCKET=${STORAGE_BUCKET:-${DIKTATOR_PROJECT_ID}.appspot.com}
GIN_MODE=release
PORT=8080
DATABASE_URL=${DATABASE_URL}
AUTH_MODE=oidc
OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-https://auth.diktator.app}
OIDC_AUDIENCE=${OIDC_AUDIENCE:-diktator}
EOF

cat > frontend/.env.production << EOF
NEXT_PUBLIC_API_URL=${DIKTATOR_API_URL:-https://${DIKTATOR_API_SERVICE_NAME}-${DIKTATOR_REGION:-${DIKTATOR_DEFAULT_REGION}}.run.app}
NEXT_PUBLIC_AUTH_MODE=oidc
NEXT_PUBLIC_OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-https://auth.diktator.app}
NEXT_PUBLIC_OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-diktator-frontend}
NEXT_TELEMETRY_DISABLED=1
NODE_ENV=production
EOF

echo "âœ… Production config created"
"""

[tasks.config-load]
description = "Load configuration from terraform"
run = """
cd terraform
if [ ! -d .terraform ]; then
    echo "Terraform not initialized. Run 'mise run tofu:init'"
    exit 1
fi

cat > ../.mise.env << EOF
DIKTATOR_PROJECT_ID=$(tofu output -raw project_id 2>/dev/null || echo "")
DIKTATOR_REGION=$(tofu output -raw region 2>/dev/null || echo "${DIKTATOR_DEFAULT_REGION}")
DIKTATOR_FRONTEND_BUCKET=$(tofu output -raw frontend_bucket_name 2>/dev/null || echo "")
DIKTATOR_API_URL=$(tofu output -raw api_url 2>/dev/null || echo "")
DATABASE_URL=$(tofu output -raw database_url 2>/dev/null || echo "")
EOF
echo "Configuration loaded to .mise.env"
"""

[tasks.config-check]
description = "Check configuration"
run = """
echo "=== Static Config ==="
echo "App: ${DIKTATOR_APP_NAME}"
echo "Region: ${DIKTATOR_DEFAULT_REGION}"

echo ""
echo "=== Development Config ==="
[ -f backend/.env.development ] && cat backend/.env.development || echo "âŒ Not found"

echo ""
echo "=== Production Config ==="
[ -f .mise.env ] && cat .mise.env || echo "âŒ Not found (run 'mise run config-load')"
"""

# ============================================================================
# Infrastructure (OpenTofu)
# ============================================================================

[tasks."tofu:init"]
description = "Initialize OpenTofu"
run = "cd terraform && tofu init"

[tasks."tofu:plan"]
description = "Plan infrastructure changes"
run = "cd terraform && tofu plan"

[tasks."tofu:apply"]
description = "Apply infrastructure"
run = "cd terraform && tofu apply"

[tasks."tofu:destroy"]
description = "Destroy infrastructure"
run = "cd terraform && tofu destroy"

[tasks."tofu:fmt"]
description = "Format terraform files"
run = "cd terraform && tofu fmt"

# ============================================================================
# Deployment
# ============================================================================

[tasks."backend:deploy"]
description = "Deploy backend to Cloud Run"
run = """
source .mise.env
mise run config-prod

cd backend
docker buildx build --platform linux/amd64 -t gcr.io/${DIKTATOR_PROJECT_ID}/${DIKTATOR_API_SERVICE_NAME}:latest --load .
docker push gcr.io/${DIKTATOR_PROJECT_ID}/${DIKTATOR_API_SERVICE_NAME}:latest

gcloud run deploy ${DIKTATOR_API_SERVICE_NAME} \
  --image gcr.io/${DIKTATOR_PROJECT_ID}/${DIKTATOR_API_SERVICE_NAME}:latest \
  --region ${DIKTATOR_REGION} \
  --platform managed \
  --allow-unauthenticated
"""

[tasks."frontend:deploy"]
description = "Deploy frontend to Cloud Storage"
run = """
source .mise.env
mise run config-prod

cd frontend
rm -rf out
cp .env.production .env.local
pnpm run build

gsutil -m cp -r out/* gs://${DIKTATOR_FRONTEND_BUCKET}/
gsutil -m setmeta -h "Cache-Control:no-cache" gs://${DIKTATOR_FRONTEND_BUCKET}/*.html
gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://${DIKTATOR_FRONTEND_BUCKET}/_next/static/**/*
"""

# ============================================================================
# CI/CD
# ============================================================================

[tasks."ci:test"]
description = "CI: Run all tests"
run = [
    "cd frontend && pnpm ci && pnpm run lint && pnpm run typecheck",
    "cd backend && go mod tidy && go test ./... && go vet ./...",
]

[tasks."ci:build-backend"]
description = "CI: Build backend image"
run = """
PROJECT_ID=${GOOGLE_CLOUD_PROJECT:-${DIKTATOR_PROJECT_ID}}
COMMIT_SHA=${GITHUB_SHA:-latest}
cd backend
docker buildx build --platform linux/amd64 -t gcr.io/${PROJECT_ID}/${DIKTATOR_API_SERVICE_NAME}:${COMMIT_SHA} --load .
docker push gcr.io/${PROJECT_ID}/${DIKTATOR_API_SERVICE_NAME}:${COMMIT_SHA}
"""

[tasks."ci:build-frontend"]
description = "CI: Build frontend"
run = """
cd frontend
pnpm ci
cp .env.production .env.local 2>/dev/null || true
pnpm run build
"""

# ============================================================================
# Google Cloud
# ============================================================================

[tasks."gcloud:auth"]
description = "Authenticate with Google Cloud"
run = "gcloud auth login && gcloud auth application-default login"

[tasks."gcloud:set-project"]
description = "Set GCP project"
run = """
if [ -z "$1" ]; then
  echo "Usage: mise run gcloud:set-project -- PROJECT_ID"
  exit 1
fi
gcloud config set project "$1"
"""
